<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ios support -->
    <link href="icon/manifest/192x192.png" rel="apple-touch-icon" />
    <meta content="#DCE9E9" name="apple-mobile-web-app-status-bar" />
    <meta content="#d1d1d1" name="theme-color" />
    <title>Orient DOTS</title>
    <link href="https://orientdots.net/avatar/assests/icon.png" rel="shortcut icon" type="image/png" />
    <link href="manifest.json" rel="manifest" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(() => {
                    console.log('Service Worker Registered!');
                });
            });
        }
    </script>
    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Tammudu+2&amp;family=Roboto:wght@100&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@600&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <!-- Include Flag Icon CSS in <head> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.7.0/css/flag-icons.min.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            opacity: 0.9;
            /* Set opacity to 0.5 */
        }

        #video-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: 1;
        }

        .iframe-overlay {
            position: fixed;
            top: 0;
            right: 0;
            /* Position on the right side */
            width: 330px;
            /* Set the width to 300px */
            height: 330px;
            /* Set the height to 300px */
            background: transparent;
            /* Set the background to transparent */
            display: block;
            /* Initially hidden */
            z-index: 3000;
            /* Set the z-index to 3000 for the overlay */
            border: none;
        }

        #open-overlay-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 3000;
            /* Set the z-index to 3000 for the button */
            background: #fff;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        #close-overlay-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            /* Above the overlay */
            background: #fff;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        /* unvisited link */
        a:link {
            color: white;
        }

        /* visited link */
        a:visited {
            color: white;
        }

        /* mouse over link */
        a:hover {
            color: white;
        }

        /* selected link */
        a:active {
            color: white;
        }

        .container-fluid {
            /* background-color: #fff; */
            max-width: 100%;
        }

        .chat-box {
            z-index: 4;
            opacity: 0.8;
            /* border: 1px solid #dee2e6; */
            border-radius: 0.25rem;
            max-height: 91vh;
            min-height: 91vh;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
            width: 25%;
        }

        #chat-box {
            display: flex;
            flex-direction: column-reverse;
            overflow-y: auto;
            max-height: 91vh;
        }

        #chat-form {
            z-index: 10000; /* High z-index to avoid overlaps */
    position: fixed;
    bottom: 0;
    width: 100%;
    left: 0;
    right: 0;
    pointer-events: auto;
        }

        @media (max-width: 767px) {

            /* Adjust the breakpoint as needed */
            .chat-box {
                width: 91%;
                max-height: 20vh;
                /* Adjust the height as needed */
                min-height: 20vh;
                position: fixed;
                bottom: 40px;
                /* Height of the chat form + some padding */
                margin-top: 0;
                /* Remove the top margin */
                left: 50%;
                transform: translateX(-50%);
            }
        }

        #chat-box {
            max-height: 20vh;
            /* Adjust the height as needed */
        }

        #chat-form {
            position: fixed;
            bottom: 0;
            width: 100%;
            left: 0;
            right: 0;
        }
        

        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .message-text {
            word-wrap: break-word;
        }

        #user-input {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000; /* Ensure it's above other elements */
            pointer-events: auto; /* Ensure it can receive clicks */
            position: relative; /* Ensure proper stacking */
        }

        .user-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: red;
            color: #fff;
            align-self: flex-end;
        }

        .chatbot-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: #000000;
        }

        .message-text {
            word-wrap: break-word;
        }

        .imgAvatar {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            /* Ensures the video maintains its aspect ratio while covering the viewport */
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        /* Apply this CSS for mobile screens */
        @media (max-width: 768px) {
            .avatar-container {
                overflow: hidden;
                /* Hide the overflowing parts */
            }

            .avatar-image {
                width: auto;
                /* Let the width adjust proportionally */
                height: 100%;
                /* Ensure the image fills the container vertically */
                margin-left: 50%;
                /* Center the image horizontally */
                transform: translateX(-50%);
                /* Adjust for centering */
            }
        }

        .full-height {
            height: 100vh;
        }

        .iframeApps {
            display: block;
            /* iframes are inline by default */
            margin: 0;
            background: #000;
            border: none;
            /* Reset default border */
            height: 100vh;
            /* Viewport-relative units */
            width: 75vw;
        }

        .iframeAva {
            display: block;
            /* iframes are inline by default */
            background: #ffffff;
            border: none;
            /* Reset default border */
            height: 100vh;
            /* Viewport-relative units */
            width: 100%;
        }

        .video-container {
            width: auto;
            height: 100%;
            display: block;
        }

        .dropdown-menu::before {
            content: '';
            display: inline-block;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 7px solid #ccc;
            border-bottom-color: #fff;
            border-bottom-color: #fff;
            position: absolute;
            top: -7px;
            left: 9px;
        }

        .sticky-div {
            position: fixed;
            top: 65px;
            right: 0;
            height: 100%;
            width: 25%;
            /* Adjust the width to your desired value */
            z-index: 1000;
        }

        .sticky-navbar {
            position: sticky;
            /* or you can use 'sticky' if you prefer */
            top: 0;
            width: 100%;
            z-index: 1000;
            /* Keeps the navbar on top of other elements */
        }

        #logo {
            position: fixed;
            margin-top: 10px;
            bottom: 100px;
            right: 30px;
            opacity: 0.80;
            z-index: 3;
        }

        /* Media query for mobile devices */
        @media (max-width: 768px) {
            #logo {
                top: 10px;
                /* Adjust as needed */
                bottom: auto;
                /* Reset the bottom property */
                right: 10px;
                /* Adjust as needed */
                left: auto;
                /* Optional, if you want to center horizontally */
                margin: 0;
                /* Reset margin */
            }
        }

        @media (max-width: 767px) and (orientation: landscape),
        /* Mobile landscape */
        (max-width: 768px) {

            .imgAvatar {
                height: auto;
                width: 100%;
            }

            /* Include the original condition */
            .iframe-overlay {
                display: none;
            }
        }

        .avatar-video {
            /* position: fixed; */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 3;
        }

        #export-controls {
            display: none !important;
        }
    </style>
    <link
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500|Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp"
        rel="stylesheet" />
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://studio.orient-telecoms.com/publishing/avatar/js/fullscreenV2.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script> -->
    <!-- Local link -->
    <link href="manifest.json" rel="manifest" />
    <script src="app.js"></script>
    <link href="./plugins/orientAI/static/icon/Css/style.css" rel="stylesheet" />
    </link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/franc@6.1.0/build/franc.min.js"></script>
</head>
<script>
    const overlayIframe = document.getElementById('overlay-iframe');
    const closeOverlayButton = document.getElementById('close-overlay-button');

    // Function to show the overlay with the external URL
    function showOverlay() {
        overlayIframe.style.display = 'block';
    }

    // Function to hide the overlay
    function hideOverlay() {
        overlayIframe.style.display = 'none';
    }

    // Add an event listener to the button to show the overlay
    document.getElementById('open-overlay-button').addEventListener('click', showOverlay);

    // Add an event listener to the close button to hide the overlay
    closeOverlayButton.addEventListener('click', hideOverlay);
</script>
<script>
    let vid = document.getElementById("imgAvatar");

    // Set default playback speed
    vid.playbackRate = 50;

</script>

<body>
    <div class="modal" id="nameModal" role="dialog"
        style="display:block; background: rgba(0,0,0,0.8); z-index:9999; position:fixed; top:0; left:0; right:0; bottom:0;"
        tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content p-4">
                <h5 class="modal-title" id="modalGreeting">Welcome! What's your name?</h5>
                <input class="form-control my-3" id="userNameInput" placeholder="Enter your name" required=""
                    type="text" />
                <button class="btn btn-primary" id="submitNameBtn">Continue</button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ ADD THIS in <body>, near the top (before container-fluid) -->
    <select id="language-selector" class="form-select"
        style="position:fixed;top:50px;left:10px;width:200px;z-index:9999;">
        <option value="auto">üåê Auto Detect</option>
        <option value="en-US">üá∫üá∏ English (US)</option>
        <option value="ms-MY">üá≤üáæ Malay</option>
        <option value="zh-CN">üá®üá≥ Chinese (Simplified)</option>
        <option value="hi-IN">üáÆüá≥ Hindi</option>
        <option value="th-TH">üáπüá≠ Thai</option>
        <option value="ja-JP">üáØüáµ Japanese</option>
        <option value="ko-KR">üá∞üá∑ Korean</option>
        <option value="fr-FR">üá´üá∑ French</option>
        <option value="de-DE">üá©üá™ German</option>
        <option value="ru-RU">üá∑üá∫ Russian</option>
        <option value="es-ES">üá™üá∏ Spanish</option>
        <option value="it-IT">üáÆüáπ Italian</option>
        <option value="tr-TR">üáπüá∑ Turkish</option>
        <option value="ar-SA">üá∏üá¶ Arabic</option>
        <option value="fa-IR">üáÆüá∑ Persian</option>
    </select>

    <div id="tts-indicator" style="
    position: fixed;
    top: 20px;
    left: 20px;
    width: 20px;
    height: 20px;
    background-color: red;
    border-radius: 50%;
    box-shadow: 0 0 10px red;
    z-index: 9999;
    display: none;">
    </div>

    <div class="video-background">
        <video autoplay="" id="video-bg" loop="" muted="">


            <source src="https://studio.orient-telecoms.com/publishing/avatar/background/ORT-AVABG18.mp4"
                type="video/mp4">


            <!-- Add more <source> tags for other video formats if needed -->
            Your browser does not support the video tag.
        </video>

        <!-- <script>
			document.getElementById('video-bg').playbackRate = 0.2; // Adjust the playback rate (0.5 means half speed)
		</script> -->

    </div>

    <div id="logo">
        <img src="https://studio.orient-telecoms.com/img/avatarstudios-final.png">
    </div>

    <!-- <iframe id="overlay-iframe" class="iframe-overlay" src="https://desktop.orient-dots.com/GPU/index.php"></iframe> -->

    <!-- <button id="open-overlay-button">Open Overlay</button>   -->

    <div class="content h-100">

        <div class="container-fluid d-flex flex-column h-100">
            <div class="row flex-grow-1">
                <div class="col-md-12 d-flex flex-column">
                    <div id="avatar-container" style="position: relative;">

                        <!-- Poster Video -->
                        <video autoplay="" class="imgAvatar avatar-video" loop="" muted="" playsinline=""
                            style="opacity:1; z-index:1;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Idle.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>
                        <!-- Idle Video -->
                        <video autoplay="" class="imgAvatar avatar-video" id="idleVideo" loop="" muted="" playsinline=""
                            style="opacity:1; z-index:2;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Idle.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>
                        <!-- Talk Video -->
                        <video autoplay="" class="imgAvatar avatar-video" id="talkVideo" loop="" muted="" playsinline=""
                            style="opacity:0; z-index:3;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Talk.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>

                    </div>

                    <script>
                        const idleVideo = document.getElementById("idleVideo");
                        const talkVideo = document.getElementById("talkVideo");

                        // Ensure both videos load and play
                        Promise.all([
                            idleVideo.play(),
                            talkVideo.play()
                        ]).then(() => {
                            idleVideo.currentTime = 0;
                            talkVideo.currentTime = 0;
                        });

                        function syncAndFade(fromVideo, toVideo) {
                            toVideo.currentTime = fromVideo.currentTime;

                            // Smooth fade transition
                            fromVideo.style.transition = "opacity 0.3s ease-in-out";
                            toVideo.style.transition = "opacity 0.3s ease-in-out";

                            fromVideo.style.opacity = "0";
                            toVideo.style.opacity = "1";
                        }

                        // Call this when speaking starts
                        function showTalkVideo() {
                            syncAndFade(idleVideo, talkVideo);
                        }

                        // Call this when speaking ends
                        function showIdleVideo() {
                            syncAndFade(talkVideo, idleVideo);
                        }
                    </script>
                    <script>
                        var video = document.getElementById('imgAvatar');

                        // Wait for the metadata to be loaded
                        video.addEventListener('loadedmetadata', function () {
                            // Set the starting time to 1 second
                            video.currentTime = 1;

                            // Play the video until 8 seconds
                            video.addEventListener('timeupdate', function () {
                                if (video.currentTime >= 6) {
                                    video.currentTime = 1; // Restart the video from 1 second
                                }
                            });
                        });
                    </script>
                    <script>
                        function toggleElements() {
                            var chatBox = document.getElementById("chat-box");

                            // Toggle visibility
                            if (chatBox.style.display === "none") {
                                chatBox.style.display = "flex";
                            } else {
                                chatBox.style.display = "none";
                            }
                        }
                    </script>
                    <script>
                        function toggleFullScreen() {
                            if (!document.fullscreenElement) {
                                document.documentElement.requestFullscreen();
                            } else {
                                if (document.exitFullscreen) {
                                    document.exitFullscreen();
                                }
                            }
                        }
                    </script>
                    <script>
                        document.addEventListener('contextmenu', function (e) {
                            e.preventDefault();
                        });
                    </script>
                    <!-- <div id="chat-box" class="chat-box flex-grow-1 mb-3 p-3 bg-light rounded"> -->
                    <div class="chat-box flex-grow-1 mb-3 p-3 rounded" id="chat-box" style="display:none">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <form class="input-group fixed-bottom px-3 py-2" id="chat-form">
                        <input autocomplete="off" class="form-control rounded-pill" id="user-input"
                            placeholder="Type your message..." required="" type="text" />
                        <button class="btn btn-primary d-none" type="submit">Send</button>
                        <span class="input-group-text">
                            <button class="btn btn-danger ms-2" id="microphone-btn" type="button">
                                <i class="fas fa-head-side-cough"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-danger ms-2" id="stop-tts-btn" type="button">
                                <i class="fas fa-head-side-cough-slash"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-warning ms-2" onclick="removeContent()" type="button">
                                <i class="fas fa-user-minus"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-info ms-2" onclick="toggleElements()" type="button">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-primary ms-2" onclick="toggleFullScreen()" type="button">
                                <i class="fas fa-expand"></i>
                            </button>
                            <!-- &nbsp;&nbsp;
							<input type="range" id="voice-speed" min="0.5" max="2" step="0.1" value="2" disabled /> -->
                            &nbsp;&nbsp;
                            <button class="btn btn-secondary ms-2" id="pause-tts-btn" type="button">
                                <i class="fas fa-pause-circle"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-success ms-2" id="resume-tts-btn" type="button">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-dark ms-2" id="save-chat-btn" type="button">
                                <i class="fas fa-save"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-outline-secondary ms-2" id="upload-chat-btn" type="button">
                                <i class="fas fa-upload"></i>
                                <input type="file" id="upload-chat-input" accept=".json,.csv" style="display:none" />
                            </button>
                        </span>
                    </form>
                    <div id="export-controls" style="margin-top: 1rem;">
                        <label>From: <input id="start-date" type="datetime-local" /></label>
                        <label>To: <input id="end-date" type="datetime-local" /></label>
                        <button class="btn btn-warning ms-2" id="export-pdf-btn">üìÑ Export to PDF</button>
                        <input accept=".json,.csv" class="ms-2" id="import-log" type="file" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let output = document.getElementById('output');
        function removeContent() {
            let divElement = document.getElementById("chat-box");
            while (divElement.firstChild) {
                divElement.removeChild(divElement.firstChild);
            }
        }
    </script>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>


    <script>

        const GEMINI_API_KEY = "AIzaSyBE4Tw_30cYCMFdZ6GirOP1Z10DE5Qafbs";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent";

        const chatBox = document.getElementById("chat-box");
        const chatForm = document.getElementById("chat-form");
        const microphoneBtn = document.getElementById("microphone-btn");
        const userInputElement = document.getElementById("user-input");

        let conversationHistory = [{ role: "assistant", content: "You are Prime the Digital AI Assistant. You are Professional." }];

        // Handles form submission and sends user input to the chatbot
        chatForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const userInputElement = document.getElementById("user-input");
            const userInput = userInputElement.value;
            appendMessage(userInput, "user");
            chatForm.reset();
            userInputElement.disabled = true;

            // Disable the user input field
            userInputElement.disabled = true;

            //conversationHistory.push({ role: "user", content: userInput });

            try {
        const response = await fetchGPTResponse(userInput);
        appendMessage(response, "chatbot");
    } catch (error) {
        console.error("Error fetching response:", error);
        appendMessage("Sorry, there was an error. Please try again.", "chatbot");
    } finally {
        userInputElement.disabled = false;
        userInputElement.focus();
    }
});

        // // Speech Recognition
        // const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        // const recognition = new SpeechRecognition();

        // const synth = window.speechSynthesis; // Move this line to the global scope

        // let shouldContinueTyping = true;

        // recognition.lang = 'ms-MY';
        // recognition.interimResults = false;
        // recognition.maxAlternatives = 1;

        // microphoneBtn.addEventListener("click", () => {
        //     recognition.start();
        // });

        // recognition.addEventListener("result", (event) => {
        //     const speechResult = event.results[0][0].transcript;
        //     document.getElementById("user-input").value = speechResult;
        // });

        // recognition.addEventListener("end", () => {
        //     const speechResult = document.getElementById("user-input").value;
        //     if (speechResult) {
        //         chatForm.dispatchEvent(new Event("submit"));
        //     }
        // });

        const synth = window.speechSynthesis;
       const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    console.error("SpeechRecognition not supported in this environment.");
    // Fallback: Disable microphone button or show a message
    document.getElementById("microphone-btn").disabled = true;
}
        const recognition = new SpeechRecognition();
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        let userName = null;

        async function detectLanguageByIP() {
            try {
                const res = await fetch("https://ipapi.co/json/");
                const data = await res.json();
                const countryCode = data.country_code;
                return mapCountryToLanguage(countryCode);
            } catch (e) {
                console.warn("IP detection failed. Fallback to browser language.");
                return navigator.language || "en-US";
            }
        }

        function mapCountryToLanguage(code) {
            const map = {
                "MY": "ms-MY", "SG": "en-US", "CN": "zh-CN", "JP": "ja-JP", "KR": "ko-KR", "TH": "th-TH", "IN": "hi-IN",
                "PH": "en-US", "VN": "en-US", "ID": "id-ID", "AE": "ar-SA", "SA": "ar-SA", "IR": "fa-IR", "TR": "tr-TR",
                "FR": "fr-FR", "DE": "de-DE", "ES": "es-ES", "IT": "it-IT", "RU": "ru-RU", "GB": "en-GB", "US": "en-US",
                "CA": "en-US", "MX": "es-ES", "BR": "pt-BR"
            };
            return map[code] || "en-US";
        }

        const greetings = {
            "en-US": "Hi! My name is", "ms-MY": "Hai! Nama saya", "zh-CN": "‰Ω†Â•ΩÔºÅÊàëÁöÑÂêçÂ≠óÊòØ", "hi-IN": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•á‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§π‡•à",
            "th-TH": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠", "ja-JP": "„Åì„Çì„Å´„Å°„ÅØÔºÅÁßÅ„ÅÆÂêçÂâç„ÅØ", "ko-KR": "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ú Ïù¥Î¶ÑÏùÄ", "fr-FR": "Bonjour! Je m'appelle",
            "de-DE": "Hallo! Ich hei√üe", "es-ES": "¬°Hola! Me llamo", "it-IT": "Ciao! Mi chiamo", "ru-RU": "–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç",
            "tr-TR": "Merhaba! Benim adƒ±m", "ar-SA": "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿßÿ≥ŸÖŸä", "fa-IR": "ÿ≥ŸÑÿßŸÖ! ÿßÿ≥ŸÖ ŸÖŸÜ", "pt-BR": "Ol√°! Meu nome √©", "auto": "Hi! My name is"
        };

        const modalGreetings = {
            "en-US": "Welcome! What's your name?", "ms-MY": "Selamat datang! Siapa nama anda?", "zh-CN": "Ê¨¢ËøéÔºÅ‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü",
            "hi-IN": "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! ‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", "th-TH": "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?", "ja-JP": "„Çà„ÅÜ„Åì„ÅùÔºÅ„ÅäÂêçÂâç„ÅØÔºü",
            "ko-KR": "ÌôòÏòÅÌï©ÎãàÎã§! Ïù¥Î¶ÑÏù¥ Î≠êÏòàÏöî?", "fr-FR": "Bienvenue ! Quel est votre nom ?", "de-DE": "Willkommen! Wie hei√üen Sie?",
            "es-ES": "¬°Bienvenido! ¬øC√≥mo te llamas?", "it-IT": "Benvenuto! Come ti chiami?", "ru-RU": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
            "tr-TR": "Ho≈ü geldiniz! Adƒ±nƒ±z nedir?", "ar-SA": "ŸÖÿ±ÿ≠ÿ®Ÿãÿß! ŸÖÿß ÿßÿ≥ŸÖŸÉÿü", "fa-IR": "ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ! ÿßÿ≥ŸÖÿ™ ⁄Ü€åŸáÿü",
            "pt-BR": "Bem-vindo! Qual √© o seu nome?", "auto": "Welcome! What's your name?"
        };

        const namePlaceholders = {
            "en-US": "Enter your name", "ms-MY": "Masukkan nama anda", "zh-CN": "ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó", "hi-IN": "‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
            "th-TH": "‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", "ja-JP": "„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "ko-KR": "Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî", "fr-FR": "Entrez votre nom",
            "de-DE": "Geben Sie Ihren Namen ein", "es-ES": "Ingresa tu nombre", "it-IT": "Inserisci il tuo nome",
            "ru-RU": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è", "tr-TR": "Adƒ±nƒ±zƒ± girin", "ar-SA": "ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ", "fa-IR": "ŸÜÿßŸÖ ÿÆŸàÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ",
            "pt-BR": "Digite seu nome", "auto": "Enter your name"
        };

        const messagePlaceholders = {
            "en-US": "Type your message...", "ms-MY": "Taip mesej anda...", "zh-CN": "ËæìÂÖ•‰Ω†ÁöÑÊ∂àÊÅØ...", "hi-IN": "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç...",
            "th-TH": "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...", "ja-JP": "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...", "ko-KR": "Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...", "fr-FR": "Tapez votre message...",
            "de-DE": "Geben Sie Ihre Nachricht ein...", "es-ES": "Escribe tu mensaje...", "it-IT": "Scrivi il tuo messaggio...",
            "ru-RU": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...", "tr-TR": "Mesajƒ±nƒ±zƒ± yazƒ±n...", "ar-SA": "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...", "fa-IR": "Ÿæ€åÿßŸÖÿ™ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥...",
            "pt-BR": "Digite sua mensagem...", "auto": "Type your message..."
        };

        function setModalGreeting(lang) {
            document.getElementById("modalGreeting").textContent = modalGreetings[lang] || modalGreetings["auto"];
        }

        function setNamePlaceholder(lang) {
            document.getElementById("userNameInput").placeholder = namePlaceholders[lang] || namePlaceholders["auto"];
        }

        function setMessagePlaceholder(lang) {
            document.getElementById("user-input").placeholder = messagePlaceholders[lang] || messagePlaceholders["auto"];
        }

        function getSelectedLanguage() {
            const selector = document.getElementById("language-selector");
            return selector ? selector.value : "auto";
        }

        const languageSelector = document.getElementById("language-selector");
        languageSelector.addEventListener("change", async function () {
            const selectedLang = this.value;
            const lang = (selectedLang === "auto") ? await detectLanguageByIP() : selectedLang;
            recognition.lang = lang;
            setModalGreeting(lang);
            setNamePlaceholder(lang);
            setMessagePlaceholder(lang);
        });

        document.addEventListener("DOMContentLoaded", async () => {
            const autoLang = await detectLanguageByIP();
            recognition.lang = autoLang;
            setModalGreeting(autoLang);
            setNamePlaceholder(autoLang);
            setMessagePlaceholder(autoLang);

            const nameModal = document.getElementById("nameModal");
            const userNameInput = document.getElementById("userNameInput");
            const submitNameBtn = document.getElementById("submitNameBtn");
            const chatBox = document.getElementById("chat-box");
            const chatForm = document.getElementById("chat-form");

            submitNameBtn.addEventListener("click", () => {
                const name = userNameInput.value.trim();
                if (!name) return alert("Please enter your name.");

                userName = name;
                nameModal.style.display = "none";

                const selectedLang = getSelectedLanguage();
                const lang = (selectedLang === "auto") ? recognition.lang : selectedLang;
                const greeting = `${greetings[lang] || greetings["auto"]} ${userName}`;

                document.getElementById("user-input").value = greeting;
                chatForm.dispatchEvent(new Event("submit"));

                chatBox.style.display = "flex";
                chatForm.style.display = "flex";
            });
        });

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Global Scope ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // const synth = window.speechSynthesis;    // text-to-speech engine

        // // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Speech Recognition Setup ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        // const recognition = new SpeechRecognition();

        // // Auto-detect browser locale, fallback to US English
        // recognition.lang = navigator.language || navigator.userLanguage || 'ms-MY';
        // recognition.interimResults = false;
        // recognition.maxAlternatives = 1;

        // let shouldContinueTyping = true;

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî UI Event Listeners ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // microphoneBtn.addEventListener("click", () => {
        // recognition.start();
        // });

        // recognition.addEventListener("result", (event) => {
        // const speechResult = event.results[0][0].transcript;
        // document.getElementById("user-input").value = speechResult;
        // });

        // recognition.addEventListener("end", () => {
        // const speechResult = document.getElementById("user-input").value;
        // if (speechResult) {
        // 	chatForm.dispatchEvent(new Event("submit"));
        // }
        // });
        microphoneBtn.addEventListener("click", () => {
    if (navigator.permissions) {
        navigator.permissions.query({ name: 'microphone' }).then((result) => {
            if (result.state === 'granted' || result.state === 'prompt') {
                recognition.start();
            } else {
                alert("Microphone access denied. Please enable it in your device settings.");
            }
        }).catch(() => {
            recognition.start(); // Fallback for unsupported Permissions API
        });
    } else {
        recognition.start();
    }
});

recognition.addEventListener("result", (event) => {
    const speechResult = event.results[0][0].transcript.trim();
    const userInputElement = document.getElementById("user-input");
    userInputElement.value = speechResult;
    userInputElement.focus(); // Return focus to input
    document.getElementById("chat-form").dispatchEvent(new Event("submit"));
});

recognition.addEventListener("end", () => {
    const userInputElement = document.getElementById("user-input");
    userInputElement.disabled = false; // Ensure input is enabled
    userInputElement.focus(); // Return focus to input
});

        // Handle speech result
        recognition.addEventListener("result", (event) => {
            const speechResult = event.results[0][0].transcript;
            document.getElementById("user-input").value = speechResult;
            document.getElementById("chat-form").dispatchEvent(new Event("submit"));
        });

        // Handle errors
        recognition.addEventListener("error", (event) => {
            if (event.error === "not-allowed" || event.error === "service-not-allowed") {
                alert("‚ùó Microphone access denied.\nPlease allow it from your browser settings.");
            } else {
                console.error("SpeechRecognition error:", event.error);
            }
        });

        // Add a stop TTS function
        function stopTTS() {
            document.getElementById("tts-indicator").style.display = "none";
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
                currentAudioElement = null;
            }
            window.speechSynthesis.cancel();
            shouldContinueTyping = false;
            showIdleVideo();
            document.getElementById("user-input").disabled = false;
        }

        // Command To Action	
        window.addEventListener("keydown", (event) => {
    const userInputElement = document.getElementById("user-input");
    if (document.activeElement === userInputElement) {
        return; // Skip keydown handling if typing in the input field
    }
    if (event.key === "ArrowDown") {
        stopTTS();
    } else if (event.key === "ArrowUp") {
        recognition.start();
    }
});

        recognition.addEventListener("result", (event) => {
            const speechResult = event.results[0][0].transcript.trim();
            const lower = speechResult.toLowerCase();

            // If user said ‚Äústop‚Äù, interrupt TTS ‚Ä¶
            if (lower === "stop") {
                stopTTS();
                return;
            }

            // Otherwise, feed it into the chat form
            //   document.getElementById("user-input").value = speechResult;
            //   document.getElementById("chat-form").dispatchEvent(new Event("submit"));
        });

        // Bind the stop TTS function to a button
        const stopTTSBtn = document.getElementById("stop-tts-btn");
        stopTTSBtn.addEventListener("click", stopTTS);

        // Get current date
        const currentDate = new Date();

        // Get current date and time
        const currentTime = new Date();

        // Format date as a string
        const formattedDate = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;

        // Format time as a string
        const formattedTime = `${currentTime.getHours()}:${currentTime.getMinutes()}:${currentTime.getSeconds()}`;

        // Display the date in the console
        console.log('Current date:', formattedDate);
        console.log('Current time:', formattedTime);

        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
        const formattedDateTime = now.toLocaleString('en-US', options);

        console.log('Current Date/Time:', formattedDateTime);

        let KnowledgeDataset =
            `${formattedDateTime} \n\n`;
        // `Today date is ${formattedDate} \n\n` +
        // `Time now is ${formattedTime} \n\n` ;

        // Display the KnowledgeDataset in the console
        console.log(KnowledgeDataset);

        const TotalWords = (500 * 25) / 100;

        const FinalWords = 500 - TotalWords;

        let promptLimit = `You are an Digital AI Assistant named Prime. Please provide responses in complete, well-structured sentences. Ensure that each response is clear, informative, and coherent even if you need to exceed maximum ${FinalWords} words.`;

        // let AvaPrompt = `You are Prime the Digital AI Assistant. You are Professional.`;

        let promptEngineering = `You are a streaming avatar from Asrix Prime Berhad, an industry-leading product that specializes in developing Ai based tools, applications and infrastructure with focus on digital business transformation for the small medium enterprise and industry (SME/SMI). Audience will try to have a conversation with you, please try to answer the questions or respond to their comments naturally, and concisely. Please try your best to respond with short answers, and only answer the last question.`;

        let systemPrompt = `Answering regarding customer support question from customers.`;

        let systemInstruction = `You only provide information related to the context prompt. If the information is not available in the context prompt or if uncertain, simply state you don't know.`;

        let pdfLinks = [
            "https://studio.orient-telecoms.com/publishing/91526-asrix-company-profile.pdf",
        ];

        let urlLinks = [
            "https://asrix.com",
        ];

        let pdfLinksText = pdfLinks.map(link => `PDF Link: ${link}`).join('\n');
        let urlLinksText = urlLinks.map(link => `URL Link: ${link}`).join('\n');

        async function fetchGPTResponse(prompt) {
    const userInputElement = document.getElementById("user-input");
    userInputElement.disabled = true; // Disable input during API call
    try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody),
        });
        console.log("API Response Status:", response.status);
        if (!response.ok) {
            const errorResponse = await response.json();
            console.error("Gemini API Error:", JSON.stringify(errorResponse, null, 2));
            throw new Error("Gemini API Error");
        }
        const jsonResponse = await response.json();
        return jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, no response.";
    } catch (error) {
        console.error("Error fetching Gemini response:", error.message);
        return "ERROR! Please check your network or API settings.";
    } finally {
        userInputElement.disabled = false; // Always re-enable input
        userInputElement.focus(); // Optional: Focus the input
    }
}

async function appendMessage(text, sender) {
    const userInputElement = document.getElementById("user-input");
    const decodedText = decodeHTMLEntities(text);
    const message = document.createElement("div");
    const now = new Date();
    const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    const timeSpan = document.createElement("div");
    timeSpan.style.fontSize = '10px';
    timeSpan.style.color = '#888';
    timeSpan.textContent = timestamp;

    message.className = sender === "user" ? "user-message" : "chatbot-message";
    const messageText = document.createElement("span");
    messageText.className = "message-text";

    try {
        if (sender === "chatbot") {
            await speak(text, messageText);
        } else {
            await typeWriter(messageText, decodedText);
        }
    } catch (error) {
        console.error("Error in appendMessage:", error);
        await typeWriter(messageText, decodedText); // Fallback to text display
    } finally {
        userInputElement.disabled = false; // Ensure input is re-enabled
        userInputElement.focus(); // Optional: Focus the input
    }

    message.appendChild(messageText);
    message.appendChild(timeSpan);
    chatBox.insertBefore(message, chatBox.firstChild);
    chatBox.scrollTop = 0;
}

        async function typeWriter(element, text, delay = 50) {
            shouldContinueTyping = true; // Reset the flag before starting typing
            for (let i = 0; i < text.length; i++) {
                if (!shouldContinueTyping) break; // Stop typing if the flag is set to false
                element.innerHTML += text[i];
                await new Promise((resolve) => setTimeout(resolve, delay));
            }
        }

        // Add this function to detect the language of the input text
        async function detectLanguage(text) {
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2/detect?key=AIzaSyAWD6iE3jsh51wUHbPYplP8mr5K_SO6XFo`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        q: text,
                    }),
                }
            );

            const data = await response.json();
            return data.data.detections[0][0].language;
        }

        async function speak(text, element, delay = 50) {
    const language = await detectLanguage(text).catch(e => {
        console.error("Language detection failed:", e);
        return "en-US"; // Fallback language
    });
    console.log("Detected Language:", language);

    const userInputElement = document.getElementById("user-input");
    const videoElement = document.getElementById("talkVideo");

    function splitText(text) {
        const chunkSize = 1200;
        const words = text.split(" ");
        const chunks = [];
        let currentChunk = "";
        words.forEach(word => {
            if (currentChunk.length + word.length + 1 > chunkSize) {
                chunks.push(currentChunk.trim() + ".");
                currentChunk = "";
            }
            currentChunk += word + " ";
        });
        if (currentChunk) chunks.push(currentChunk.trim() + ".");
        return chunks;
    }

    const textChunks = splitText(text);
    let currentChunkIndex = 0;

    async function speakChunk() {
        if (currentChunkIndex >= textChunks.length) {
            document.getElementById("tts-indicator").style.display = "none";
            showIdleVideo();
            userInputElement.disabled = false;
            userInputElement.focus();
            return;
        }

        const correctedChunk = textChunks[currentChunkIndex]
            .replace(/&#x27;/g, "'")
            .replace(/&quot;/g, "'")
            .replace(/\*smiles\*/g, "")
            .replace(/\*smile\*/g, "")
            .replace(/\*smiling\*/g, "")
            .replace(/\*excited tone\*/g, "")
            .replace(/\*nods enthusiastically\*/g, "")
            .replace(/\*nods\*/g, "")
            .replace(/\*winks\*/g, "")
            .replace(/\*chuckles\*/g, "")
            .replace(/\*curious\*/g, "")
            .replace(/\(smiling\)/g, "")
            .replace(/&amp;/g, "&");

        try {
            console.log("Speaking chunk:", correctedChunk);
            const apiKey = "5d12cfd99427d32fa2f305d3a0ed96a1"; // Replace with secure storage in production
            const voiceId = "IKne3meq5aSn9XLyUdCD";
            const response = await fetch(
                `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}?optimize_streaming_latency=0`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "xi-api-key": apiKey,
                    },
                    body: JSON.stringify({
                        text: correctedChunk,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: {
                            stability: 1,
                            similarity_boost: 1,
                            style: 0.5,
                            use_speaker_boost: true,
                        },
                    }),
                }
            );

            console.log("ElevenLabs API Response Status:", response.status);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ElevenLabs API failed: ${errorText}`);
            }

            const audioBlob = await response.blob();
            console.log("Audio Blob Size:", audioBlob.size);
            const audioURL = URL.createObjectURL(audioBlob);
            console.log("Audio URL:", audioURL);

            const audioElement = new Audio(audioURL);
            currentAudioElement = audioElement;

            audioElement.onplay = () => {
                console.log("Audio playing");
                document.getElementById("tts-indicator").style.display = "block";
                showTalkVideo();
                videoElement.play().catch(e => console.error("Video play failed:", e));
            };

            audioElement.onended = () => {
                console.log("Audio ended");
                document.getElementById("tts-indicator").style.display = "none";
                URL.revokeObjectURL(audioURL); // Clean up
                currentChunkIndex++;
                speakChunk(); // Process next chunk
            };

            audioElement.onerror = error => {
                console.error("Audio playback error:", error);
                throw new Error("Audio playback failed");
            };

            await typeWriter(element, correctedChunk, delay);
            await audioElement.play().catch(error => {
                console.error("Error playing audio:", error);
                throw error;
            });
        } catch (error) {
            console.error("ElevenLabs error:", error);
            // Fallback to speechSynthesis
            try {
                const synth = window.speechSynthesis;
                if (!synth) throw new Error("speechSynthesis not supported");

                const voices = synth.getVoices();
                console.log("Available voices:", voices.map(v => `${v.name} (${v.lang})`));
                const selectedVoice = voices.find(v => v.lang.startsWith(language)) || voices[0];

                if (!selectedVoice) {
                    console.warn("No suitable voice found, skipping speech");
                    await typeWriter(element, correctedChunk, delay);
                    currentChunkIndex++;
                    speakChunk();
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(correctedChunk);
                utterance.lang = language;
                utterance.voice = selectedVoice;
                utterance.onstart = () => {
                    console.log("SpeechSynthesis started");
                    document.getElementById("tts-indicator").style.display = "block";
                    showTalkVideo();
                };
                utterance.onend = () => {
                    console.log("SpeechSynthesis ended");
                    document.getElementById("tts-indicator").style.display = "none";
                    showIdleVideo();
                    currentChunkIndex++;
                    speakChunk();
                };
                utterance.onerror = error => {
                    console.error("SpeechSynthesis error:", error);
                };

                await typeWriter(element, correctedChunk, delay);
                synth.speak(utterance);
            } catch (synthError) {
                console.error("SpeechSynthesis fallback failed:", synthError);
                // Fallback to text-only display
                await typeWriter(element, correctedChunk, delay);
                currentChunkIndex++;
                speakChunk();
            }
        }
    }

    const synth = window.speechSynthesis;
    if (synth.getVoices().length !== 0) {
        speakChunk();
    } else {
        synth.addEventListener("voiceschanged", () => {
            console.log("Voices loaded");
            speakChunk();
        }, { once: true });
    }
}

        // Function to decode HTML entities
        function decodeHTMLEntities(input) {
            const doc = new DOMParser().parseFromString(input, "text/html");
            return doc.documentElement.textContent;
        }

        // Modify the JavaScript code to append new messages at the top of the chat box
        async function fetchGPTResponse(prompt) {
    const headers = {
        "Content-Type": "application/json"
    };
    const requestBody = {
        model: 'gemini-2.5-flash',
        contents: [{
            role: 'user',
            parts: [{ text: prompt + systemPrompt + promptLimit + '\n\n' + pdfLinksText + '\n\n' + urlLinksText + '\n\n' }]
        }],
        generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 500,
            topP: 0.8,
            topK: 40
        },
        safetySettings: [
            {
                category: "HARM_CATEGORY_HARASSMENT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                category: "HARM_CATEGORY_HATE_SPEECH",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
            }
        ]
    };

    try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(requestBody),
        });
        console.log("API Response Status:", response.status);
        if (!response.ok) {
            const errorResponse = await response.json();
            console.error("Gemini API Error:", JSON.stringify(errorResponse, null, 2));
            throw new Error("Gemini API Error");
        }
        const jsonResponse = await response.json();
        console.log("API Response:", JSON.stringify(jsonResponse, null, 2));
        return jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, no response.";
    } catch (error) {
        console.error("Error fetching Gemini response:", error.message);
        return "ERROR! Please check your network or API settings.";
    }   finally {
        userInputElement.disabled = false;
        userInputElement.focus();
    }
}

async function appendMessage(text, sender) {
    const decodedText = decodeHTMLEntities(text);
    const message = document.createElement("div");
    const now = new Date();
    const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    const timeSpan = document.createElement("div");
    timeSpan.style.fontSize = '10px';
    timeSpan.style.color = '#888';
    timeSpan.textContent = timestamp;

    message.className = sender === "user" ? "user-message" : "chatbot-message";
    const messageText = document.createElement("span");
    messageText.className = "message-text";

    try {
        if (sender === "chatbot") {
            await speak(text, messageText);
        } else {
            await typeWriter(messageText, decodedText);
        }
    } catch (error) {
        console.error("Error in appendMessage:", error);
        await typeWriter(messageText, decodedText); // Fallback to text display
    }   finally {
        userInputElement.disabled = false;
        userInputElement.focus();
    }

    message.appendChild(messageText);
    message.appendChild(timeSpan);
    chatBox.insertBefore(message, chatBox.firstChild);
    chatBox.scrollTop = 0;
}


        let isPaused = false;
        function pauseTTS() {
            if (currentAudioElement) {
                currentAudioElement.pause();
                isPaused = true;
            }
        }
        function resumeTTS() {
            if (currentAudioElement && isPaused) {
                currentAudioElement.play();
                isPaused = false;
            }
        }
    </script>
    <script>
        const idleVideo = document.getElementById("idleVideo");
        const talkVideo = document.getElementById("talkVideo");

        // Ensure both videos preload and stay in sync
        idleVideo.loop = true;
        idleVideo.muted = true;
        talkVideo.loop = false;
        talkVideo.muted = true;

        Promise.all([
            idleVideo.play().catch(() => { }),
            talkVideo.play().catch(() => { })
        ]).then(() => {
            idleVideo.currentTime = 0;
            talkVideo.currentTime = 0;
        });

        // Smooth transition between idle and talk
        function syncAndFade(fromVideo, toVideo) {
            toVideo.currentTime = 0;
            fromVideo.style.transition = "opacity 0.3s ease-in-out";
            toVideo.style.transition = "opacity 0.3s ease-in-out";
            fromVideo.style.opacity = "0";
            toVideo.style.opacity = "1";
        }

        function showTalkVideo() {
            syncAndFade(idleVideo, talkVideo);
            talkVideo.play().catch(() => { });
        }

        function showIdleVideo() {
            syncAndFade(talkVideo, idleVideo);
            idleVideo.play().catch(() => { });
        }

        // üîÅ Optional Auto-Loop Demo: idle <-> talk every 4 seconds
        let autoLoop = true; // Set to false if you only want real voice control
        if (autoLoop) {
            let isTalking = false;
            setInterval(() => {
                if (isTalking) {
                    showIdleVideo();
                } else {
                    showTalkVideo();
                }
                isTalking = !isTalking;
            }, 4000); // Toggle every 4 seconds
        }

        // Optional: toggle manually from console or trigger
        window.showTalkVideo = showTalkVideo;
        window.showIdleVideo = showIdleVideo;
    </script>
    <script>
        document.getElementById("pause-tts-btn").addEventListener("click", pauseTTS);
        document.getElementById("resume-tts-btn").addEventListener("click", resumeTTS);
    </script>
    <script>
        document.getElementById("save-chat-btn").addEventListener("click", function () {
            const start = new Date(document.getElementById("start-date").value);
            const end = new Date(document.getElementById("end-date").value);
            const chatBox = document.getElementById("chat-box");
            const messages = [];
            chatBox.querySelectorAll(".user-message, .chatbot-message").forEach(msg => {
                const type = msg.classList.contains("user-message") ? "user" : "bot";
                const text = msg.querySelector("span.message-text")?.innerText || "";
                const time = msg.querySelector("div")?.innerText || "";
                const timestamp = new Date(time);
                if ((!isNaN(start) && timestamp < start) || (!isNaN(end) && timestamp > end)) return;
                messages.push({ type, text, time });
            });

            const format = prompt("Save as: json or csv?", "json").toLowerCase();
            const now = new Date();
            const filenameTime = now.toISOString().replace(/[:.]/g, "-");
            let blob;
            let filename;

            if (format === "csv") {
                const csv = "type,time,text\n" + messages.map(m =>
                    `"${m.type}","${m.time}","${m.text.replace(/"/g, '""')}"`).join("\n");
                blob = new Blob([csv], { type: "text/csv" });
                filename = `chatlog-${filenameTime}.csv`;
            } else {
                const json = JSON.stringify(messages, null, 2);
                blob = new Blob([json], { type: "application/json" });
                filename = `chatlog-${filenameTime}.json`;
            }

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        });

        // Export to PDF using jsPDF
        document.getElementById("export-pdf-btn").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;
            const chatBox = document.getElementById("chat-box");
            doc.setFontSize(10);
            chatBox.querySelectorAll(".user-message, .chatbot-message").forEach(msg => {
                const type = msg.classList.contains("user-message") ? "User" : "Bot";
                const text = msg.querySelector("span.message-text")?.innerText || "";
                const time = msg.querySelector("div")?.innerText || "";
                const line = `[${time}] ${type}: ${text}`;
                const lines = doc.splitTextToSize(line, 180);
                lines.forEach(l => {
                    doc.text(l, 10, y);
                    y += 6;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                });
            });
            doc.save("chatlog.pdf");
        });

        // Upload and parse log file
        document.getElementById("import-log").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let content = e.target.result;
                    const messages = file.name.endsWith(".csv") ? parseCSV(content) : JSON.parse(content);
                    messages.forEach(msg => {
                        const msgDiv = document.createElement("div");
                        msgDiv.className = msg.type === "user" ? "user-message" : "chatbot-message";
                        const span = document.createElement("span");
                        span.className = "message-text";
                        span.textContent = msg.text;
                        const timeDiv = document.createElement("div");
                        timeDiv.style.fontSize = '10px';
                        timeDiv.style.color = '#888';
                        timeDiv.textContent = msg.time;
                        msgDiv.appendChild(span);
                        msgDiv.appendChild(timeDiv);
                        document.getElementById("chat-box").appendChild(msgDiv);
                    });
                } catch (err) {
                    alert("Error parsing file.");
                }
            };
            reader.readAsText(file);
        });

        function parseCSV(content) {
            const lines = content.trim().split("\n");
            const headers = lines.shift().split(",");
            return lines.map(line => {
                const parts = line.split(",");
                return {
                    type: parts[0].replace(/"/g, ''),
                    time: parts[1].replace(/"/g, ''),
                    text: parts.slice(2).join(",").replace(/"/g, '')
                };
            });
        }
    </script>

    <script>
        document.getElementById("upload-chat-btn").addEventListener("click", () => {
            document.getElementById("upload-chat-input").click();
        });

        document.getElementById("upload-chat-input").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let content = e.target.result;
                    const messages = file.name.endsWith(".csv") ? parseCSV(content) : JSON.parse(content);
                    messages.forEach(msg => {
                        const msgDiv = document.createElement("div");
                        msgDiv.className = msg.type === "user" ? "user-message" : "chatbot-message";
                        const span = document.createElement("span");
                        span.className = "message-text";
                        span.textContent = msg.text;
                        const timeDiv = document.createElement("div");
                        timeDiv.style.fontSize = '10px';
                        timeDiv.style.color = '#888';
                        timeDiv.textContent = msg.time;
                        msgDiv.appendChild(span);
                        msgDiv.appendChild(timeDiv);
                        document.getElementById("chat-box").appendChild(msgDiv);
                    });
                } catch (err) {
                    alert("Error parsing chat log.");
                }
            };
            reader.readAsText(file);
        });
    </script>


</body>

</html>
